generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  teams     Team[]
  users     User[]
}

model User {
  id                     String                  @id @default(cuid())
  email                  String                  @unique
  username               String                  @unique
  hashedPass             String
  displayName            String
  avatarUrl              String?
  orgId                  String?
  bio                    String?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  disabledAt             DateTime?
  emailVerified          DateTime?
  emailVerificationToken String?                 @unique
  auditLogs              AuditLog[]              @relation("audit_logs")
  comments               Comment[]
  emailVerification      EmailVerificationToken?
  follows                Follow[]                @relation("user_follows")
  followers              Follow[]                @relation("user_followers")
  mediaAssets            MediaAsset[]            @relation("media_assets")
  notifications          Notification[]
  addedTags              PlayerTag[]             @relation("player_tags")
  reactions              Reaction[]
  reports                Report[]                @relation("report_author")
  reviews                ReportReview[]          @relation("report_reviews")
  reportVersions         ReportVersion[]         @relation("report_versions")
  organization           Organization?           @relation(fields: [orgId], references: [id])
  roles                  UserRole[]

  @@index([orgId])
}

model EmailVerificationToken {
  id        String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  token     String
  userId    String   @unique
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  expiresAt DateTime @db.Timestamptz(6)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
}

model Role {
  id    String       @id @default(dbgenerated("(gen_random_uuid())::text"))
  name  UserRoleEnum @unique
  users UserRole[]
}

model UserRole {
  userId     String
  roleId     String
  assignedAt DateTime @default(now())
  role       Role     @relation(fields: [roleId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@id([userId, roleId])
  @@index([roleId])
}

model Nationality {
  code    String   @id
  name    String
  players Player[]
  teams   Team[]
}

model Team {
  id              String        @id @default(cuid())
  name            String
  shortName       String?
  country         String?
  nationalityCode String?
  orgId           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  homeStadiumId   String?
  appearances     Appearance[]
  players         Contract[]
  lineups         Lineup[]
  awayMatches     Match[]       @relation("away_team")
  homeMatches     Match[]       @relation("home_team")
  events          MatchEvent[]  @relation("team_events")
  currentPlayers  Player[]      @relation("current_team")
  homeStadium     Stadium?      @relation("team_stadium", fields: [homeStadiumId], references: [id])
  nationality     Nationality?  @relation(fields: [nationalityCode], references: [code])
  organization    Organization? @relation(fields: [orgId], references: [id])

  @@index([orgId])
}

model Player {
  id              String         @id @default(cuid())
  firstName       String
  lastName        String
  birthDate       DateTime?
  heightCm        Int?
  weightKg        Int?
  footed          Footed?
  primaryPosition PositionGroup?
  positions       String[]
  nationalityCode String?
  currentTeamId   String?
  externalIds     Json?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  deletedAt       DateTime?
  appearances     Appearance[]
  contracts       Contract[]
  followers       Follow[]       @relation("player_followers")
  events          MatchEvent[]   @relation("player_events")
  media           MediaAsset[]   @relation("player_media")
  currentTeam     Team?          @relation("current_team", fields: [currentTeamId], references: [id])
  nationality     Nationality?   @relation(fields: [nationalityCode], references: [code])
  tags            PlayerTag[]
  reports         Report[]

  @@index([lastName, firstName])
  @@index([currentTeamId])
}

model PlayerTag {
  id        String   @id @default(cuid())
  playerId  String
  tagId     String
  addedById String?
  createdAt DateTime @default(now())
  addedBy   User?    @relation("player_tags", fields: [addedById], references: [id])
  player    Player   @relation(fields: [playerId], references: [id])
  tag       Tag      @relation("tag_players", fields: [tagId], references: [id])

  @@unique([playerId, tagId])
  @@index([tagId])
}

model Contract {
  id          String    @id @default(cuid())
  playerId    String
  teamId      String
  startDate   DateTime
  endDate     DateTime?
  shirtNumber Int?
  player      Player    @relation(fields: [playerId], references: [id])
  team        Team      @relation(fields: [teamId], references: [id])

  @@index([teamId])
  @@index([playerId, teamId])
}

model Stadium {
  id        String   @id @default(cuid())
  name      String
  city      String?
  country   String?
  capacity  Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  matches   Match[]
  teams     Team[]   @relation("team_stadium")
}

model Competition {
  id        String   @id @default(cuid())
  name      String
  country   String?
  level     Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  seasons   Season[]

  @@unique([name, country])
}

model Season {
  id            String      @id @default(cuid())
  competitionId String
  name          String
  startDate     DateTime
  endDate       DateTime
  matches       Match[]
  competition   Competition @relation(fields: [competitionId], references: [id])

  @@unique([competitionId, name])
  @@index([startDate, endDate])
}

model Match {
  id          String       @id @default(cuid())
  seasonId    String
  date        DateTime
  round       String?
  homeTeamId  String
  awayTeamId  String
  stadiumId   String?
  homeGoals   Int?
  awayGoals   Int?
  status      String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  appearances Appearance[]
  lineups     Lineup[]
  awayTeam    Team         @relation("away_team", fields: [awayTeamId], references: [id])
  homeTeam    Team         @relation("home_team", fields: [homeTeamId], references: [id])
  season      Season       @relation(fields: [seasonId], references: [id])
  stadium     Stadium?     @relation(fields: [stadiumId], references: [id])
  events      MatchEvent[]
  media       MediaAsset[]
  reports     Report[]

  @@index([seasonId, date])
  @@index([homeTeamId, awayTeamId])
}

model Lineup {
  id        String  @id @default(cuid())
  matchId   String
  teamId    String
  formation String?
  coach     String?
  match     Match   @relation(fields: [matchId], references: [id])
  team      Team    @relation(fields: [teamId], references: [id])

  @@unique([matchId, teamId])
}

model Appearance {
  id        String  @id @default(cuid())
  matchId   String
  playerId  String
  teamId    String
  minuteIn  Int?
  minuteOut Int?
  position  String?
  rating    Float?
  isStarter Boolean @default(false)
  match     Match   @relation(fields: [matchId], references: [id])
  player    Player  @relation(fields: [playerId], references: [id])
  team      Team    @relation(fields: [teamId], references: [id])

  @@unique([matchId, playerId])
  @@index([teamId])
}

model MatchEvent {
  id       String  @id @default(cuid())
  matchId  String
  minute   Int
  type     String
  playerId String?
  teamId   String?
  meta     Json?
  match    Match   @relation(fields: [matchId], references: [id])
  player   Player? @relation("player_events", fields: [playerId], references: [id])
  team     Team?   @relation("team_events", fields: [teamId], references: [id])

  @@index([matchId, minute])
  @@index([playerId])
}

model Tag {
  id         String      @id @default(cuid())
  label      String      @unique
  color      String?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  playerTags PlayerTag[] @relation("tag_players")
  reports    ReportTag[]
}

model Report {
  id          String              @id @default(cuid())
  title       String?
  strengths   String?
  weaknesses  String?
  matchDate   DateTime?
  playerId    String
  authorId    String
  status      ReportStatus        @default(DRAFT)
  visibility  Visibility          @default(PRIVATE)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  approvedAt  DateTime?
  deletedAt   DateTime?
  matchId     String?
  overall     Float?
  potential   String?
  rejectedAt  DateTime?
  submittedAt DateTime?
  summary     String?
  comments    Comment[]
  media       MediaAsset[]
  reactions   Reaction[]          @relation("report_reactions")
  author      User                @relation("report_author", fields: [authorId], references: [id])
  match       Match?              @relation(fields: [matchId], references: [id])
  player      Player              @relation(fields: [playerId], references: [id])
  metrics     ReportMetricValue[]
  approvals   ReportReview[]
  tags        ReportTag[]
  versions    ReportVersion[]

  @@index([playerId])
  @@index([matchId])
  @@index([authorId])
  @@index([status, visibility])
}

model ReportReview {
  id         String         @id @default(cuid())
  reportId   String
  reviewerId String
  decision   ReviewDecision @default(PENDING)
  decidedAt  DateTime?
  note       String?
  report     Report         @relation(fields: [reportId], references: [id])
  reviewer   User           @relation("report_reviews", fields: [reviewerId], references: [id])

  @@unique([reportId, reviewerId])
  @@index([reviewerId])
}

model ReportMetric {
  id        String              @id @default(cuid())
  key       String              @unique
  label     String
  group     String?
  scaleMin  Int                 @default(1)
  scaleMax  Int                 @default(10)
  weight    Float               @default(1)
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  values    ReportMetricValue[]
}

model ReportMetricValue {
  id            String       @id @default(cuid())
  reportId      String
  metricId      String
  value         Int
  justification String?
  metric        ReportMetric @relation(fields: [metricId], references: [id])
  report        Report       @relation(fields: [reportId], references: [id])

  @@unique([reportId, metricId])
  @@index([metricId])
}

model ReportTag {
  reportId String
  tagId    String
  report   Report @relation(fields: [reportId], references: [id])
  tag      Tag    @relation(fields: [tagId], references: [id])

  @@id([reportId, tagId])
}

model MediaAsset {
  id          String   @id @default(cuid())
  url         String
  playerId    String?
  reportId    String?
  createdAt   DateTime @default(now())
  createdById String?
  description String?
  kind        String
  matchId     String?
  provider    String?
  title       String?
  createdBy   User?    @relation("media_assets", fields: [createdById], references: [id])
  match       Match?   @relation(fields: [matchId], references: [id])
  player      Player?  @relation("player_media", fields: [playerId], references: [id])
  report      Report?  @relation(fields: [reportId], references: [id])

  @@index([playerId, matchId, reportId])
}

model Comment {
  id        String     @id @default(cuid())
  authorId  String
  reportId  String
  createdAt DateTime   @default(now())
  body      String
  deletedAt DateTime?
  updatedAt DateTime   @updatedAt
  author    User       @relation(fields: [authorId], references: [id])
  report    Report     @relation(fields: [reportId], references: [id])
  reactions Reaction[] @relation("comment_reactions")

  @@index([reportId, createdAt])
}

model Reaction {
  id        String       @id @default(cuid())
  type      ReactionType
  userId    String
  reportId  String?
  commentId String?
  createdAt DateTime     @default(now())
  comment   Comment?     @relation("comment_reactions", fields: [commentId], references: [id])
  report    Report?      @relation("report_reactions", fields: [reportId], references: [id])
  user      User         @relation(fields: [userId], references: [id])

  @@unique([userId, type, reportId, commentId])
  @@index([reportId])
  @@index([commentId])
}

model Follow {
  id                String   @id @default(cuid())
  followerId        String
  createdAt         DateTime @default(now())
  followingPlayerId String?
  followingUserId   String?
  follower          User     @relation("user_follows", fields: [followerId], references: [id])
  followingPlayer   Player?  @relation("player_followers", fields: [followingPlayerId], references: [id])
  followingUser     User?    @relation("user_followers", fields: [followingUserId], references: [id])

  @@unique([followerId, followingUserId, followingPlayerId])
  @@index([followingUserId])
  @@index([followingPlayerId])
}

model Notification {
  id        String    @id @default(cuid())
  userId    String
  type      String
  readAt    DateTime?
  createdAt DateTime  @default(now())
  data      Json
  user      User      @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
}

model ReportVersion {
  id          String   @id @default(cuid())
  reportId    String
  createdAt   DateTime @default(now())
  createdById String
  snapshot    Json
  version     Int
  createdBy   User     @relation("report_versions", fields: [createdById], references: [id])
  report      Report   @relation(fields: [reportId], references: [id])

  @@unique([reportId, version])
  @@index([createdById])
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  entity    String
  entityId  String
  createdAt DateTime @default(now())
  actorId   String?
  diff      Json?
  ip        String?
  userAgent String?
  actor     User?    @relation("audit_logs", fields: [actorId], references: [id])

  @@index([entity, entityId, createdAt])
}

enum UserRoleEnum {
  ADMIN
  SCOUT
  COACH
  RECRUITER
  VIEWER
  AGENT
}

enum Visibility {
  PRIVATE
  TEAM
  ORG
  PUBLIC
}

enum ReportStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  ARCHIVED
}

enum ReviewDecision {
  PENDING
  APPROVED
  REJECTED
}

enum Footed {
  LEFT
  RIGHT
  BOTH
}

enum PositionGroup {
  GK
  DF
  MF
  FW
}

enum ReactionType {
  LIKE
  USEFUL
}
